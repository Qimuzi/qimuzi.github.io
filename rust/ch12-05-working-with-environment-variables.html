<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>处理环境变量</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/rust/assets/css/0.styles.fa1ca757.css" as="style"><link rel="preload" href="/rust/assets/js/app.4b754adf.js" as="script"><link rel="preload" href="/rust/assets/js/2.75a4d7fc.js" as="script"><link rel="preload" href="/rust/assets/js/69.6ff560c5.js" as="script"><link rel="prefetch" href="/rust/assets/js/10.c4d31c3a.js"><link rel="prefetch" href="/rust/assets/js/100.bd3f2cff.js"><link rel="prefetch" href="/rust/assets/js/101.abb08d4a.js"><link rel="prefetch" href="/rust/assets/js/102.f0234b1f.js"><link rel="prefetch" href="/rust/assets/js/103.3c1916d2.js"><link rel="prefetch" href="/rust/assets/js/104.0ad7dec0.js"><link rel="prefetch" href="/rust/assets/js/105.8f835ef5.js"><link rel="prefetch" href="/rust/assets/js/106.d6b036ae.js"><link rel="prefetch" href="/rust/assets/js/107.c5cc9141.js"><link rel="prefetch" href="/rust/assets/js/108.c99eb5a6.js"><link rel="prefetch" href="/rust/assets/js/109.b03eb33d.js"><link rel="prefetch" href="/rust/assets/js/11.d071ecd7.js"><link rel="prefetch" href="/rust/assets/js/110.c00ab61e.js"><link rel="prefetch" href="/rust/assets/js/111.2c636629.js"><link rel="prefetch" href="/rust/assets/js/112.ff2585e7.js"><link rel="prefetch" href="/rust/assets/js/113.2231eeca.js"><link rel="prefetch" href="/rust/assets/js/114.9fc843ff.js"><link rel="prefetch" href="/rust/assets/js/115.cb2f3157.js"><link rel="prefetch" href="/rust/assets/js/12.01431a27.js"><link rel="prefetch" href="/rust/assets/js/13.001954fa.js"><link rel="prefetch" href="/rust/assets/js/14.de568c61.js"><link rel="prefetch" href="/rust/assets/js/15.5ac216a1.js"><link rel="prefetch" href="/rust/assets/js/16.222b11f3.js"><link rel="prefetch" href="/rust/assets/js/17.b6326e99.js"><link rel="prefetch" href="/rust/assets/js/18.fb9a3204.js"><link rel="prefetch" href="/rust/assets/js/19.c40fb353.js"><link rel="prefetch" href="/rust/assets/js/20.6e099f21.js"><link rel="prefetch" href="/rust/assets/js/21.7b5f3f66.js"><link rel="prefetch" href="/rust/assets/js/22.9fc504df.js"><link rel="prefetch" href="/rust/assets/js/23.d538d1ab.js"><link rel="prefetch" href="/rust/assets/js/24.a796d785.js"><link rel="prefetch" href="/rust/assets/js/25.09bd24d4.js"><link rel="prefetch" href="/rust/assets/js/26.1e35db85.js"><link rel="prefetch" href="/rust/assets/js/27.1f871708.js"><link rel="prefetch" href="/rust/assets/js/28.8c4e7483.js"><link rel="prefetch" href="/rust/assets/js/29.1178a9ae.js"><link rel="prefetch" href="/rust/assets/js/3.683f279d.js"><link rel="prefetch" href="/rust/assets/js/30.d28dae6a.js"><link rel="prefetch" href="/rust/assets/js/31.1cc1ad6d.js"><link rel="prefetch" href="/rust/assets/js/32.4522b328.js"><link rel="prefetch" href="/rust/assets/js/33.98c6aa23.js"><link rel="prefetch" href="/rust/assets/js/34.18354973.js"><link rel="prefetch" href="/rust/assets/js/35.b656f117.js"><link rel="prefetch" href="/rust/assets/js/36.5e3be7dc.js"><link rel="prefetch" href="/rust/assets/js/37.03e3a71e.js"><link rel="prefetch" href="/rust/assets/js/38.b6004116.js"><link rel="prefetch" href="/rust/assets/js/39.012f0a72.js"><link rel="prefetch" href="/rust/assets/js/4.597ed44d.js"><link rel="prefetch" href="/rust/assets/js/40.9d015e97.js"><link rel="prefetch" href="/rust/assets/js/41.60807ed5.js"><link rel="prefetch" href="/rust/assets/js/42.71635b10.js"><link rel="prefetch" href="/rust/assets/js/43.d6f0ac7a.js"><link rel="prefetch" href="/rust/assets/js/44.ffd8f567.js"><link rel="prefetch" href="/rust/assets/js/45.68911785.js"><link rel="prefetch" href="/rust/assets/js/46.332d8d2c.js"><link rel="prefetch" href="/rust/assets/js/47.3d116305.js"><link rel="prefetch" href="/rust/assets/js/48.acd0d681.js"><link rel="prefetch" href="/rust/assets/js/49.64add7de.js"><link rel="prefetch" href="/rust/assets/js/5.9af330d4.js"><link rel="prefetch" href="/rust/assets/js/50.9def89da.js"><link rel="prefetch" href="/rust/assets/js/51.721f8e1b.js"><link rel="prefetch" href="/rust/assets/js/52.5cefa170.js"><link rel="prefetch" href="/rust/assets/js/53.d1b10d43.js"><link rel="prefetch" href="/rust/assets/js/54.39a7a255.js"><link rel="prefetch" href="/rust/assets/js/55.b2edd6e5.js"><link rel="prefetch" href="/rust/assets/js/56.fa009224.js"><link rel="prefetch" href="/rust/assets/js/57.54af133a.js"><link rel="prefetch" href="/rust/assets/js/58.33d53447.js"><link rel="prefetch" href="/rust/assets/js/59.73795052.js"><link rel="prefetch" href="/rust/assets/js/6.1c64da84.js"><link rel="prefetch" href="/rust/assets/js/60.8d9eeb18.js"><link rel="prefetch" href="/rust/assets/js/61.9a7b25dd.js"><link rel="prefetch" href="/rust/assets/js/62.4447972a.js"><link rel="prefetch" href="/rust/assets/js/63.d4935616.js"><link rel="prefetch" href="/rust/assets/js/64.77a791dd.js"><link rel="prefetch" href="/rust/assets/js/65.7d104c97.js"><link rel="prefetch" href="/rust/assets/js/66.86d487e7.js"><link rel="prefetch" href="/rust/assets/js/67.1c6e6984.js"><link rel="prefetch" href="/rust/assets/js/68.0911a62c.js"><link rel="prefetch" href="/rust/assets/js/7.1c537d43.js"><link rel="prefetch" href="/rust/assets/js/70.7b641d12.js"><link rel="prefetch" href="/rust/assets/js/71.94e85269.js"><link rel="prefetch" href="/rust/assets/js/72.56a92551.js"><link rel="prefetch" href="/rust/assets/js/73.668fc570.js"><link rel="prefetch" href="/rust/assets/js/74.d33971de.js"><link rel="prefetch" href="/rust/assets/js/75.608111f8.js"><link rel="prefetch" href="/rust/assets/js/76.622ee336.js"><link rel="prefetch" href="/rust/assets/js/77.4d928952.js"><link rel="prefetch" href="/rust/assets/js/78.a9dc776c.js"><link rel="prefetch" href="/rust/assets/js/79.05b47355.js"><link rel="prefetch" href="/rust/assets/js/8.50f79b9d.js"><link rel="prefetch" href="/rust/assets/js/80.012a9035.js"><link rel="prefetch" href="/rust/assets/js/81.42987af0.js"><link rel="prefetch" href="/rust/assets/js/82.bb693baa.js"><link rel="prefetch" href="/rust/assets/js/83.7b710a46.js"><link rel="prefetch" href="/rust/assets/js/84.18dd70f4.js"><link rel="prefetch" href="/rust/assets/js/85.d7558ad4.js"><link rel="prefetch" href="/rust/assets/js/86.0629b4df.js"><link rel="prefetch" href="/rust/assets/js/87.bb99f71a.js"><link rel="prefetch" href="/rust/assets/js/88.abb1a49a.js"><link rel="prefetch" href="/rust/assets/js/89.29e8b8f8.js"><link rel="prefetch" href="/rust/assets/js/9.00986011.js"><link rel="prefetch" href="/rust/assets/js/90.83064199.js"><link rel="prefetch" href="/rust/assets/js/91.ddb9e400.js"><link rel="prefetch" href="/rust/assets/js/92.1fcefcfb.js"><link rel="prefetch" href="/rust/assets/js/93.74430079.js"><link rel="prefetch" href="/rust/assets/js/94.178cfff1.js"><link rel="prefetch" href="/rust/assets/js/95.c6538afc.js"><link rel="prefetch" href="/rust/assets/js/96.5ef16eab.js"><link rel="prefetch" href="/rust/assets/js/97.1dc9bfe6.js"><link rel="prefetch" href="/rust/assets/js/98.058d612f.js"><link rel="prefetch" href="/rust/assets/js/99.672b17b7.js">
    <link rel="stylesheet" href="/rust/assets/css/0.styles.fa1ca757.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rust/" class="nav-link">
  回首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rust/" class="nav-link">
  回首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>处理环境变量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust/ch12-05-working-with-environment-variables.html#处理环境变量" class="sidebar-link">处理环境变量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/ch12-05-working-with-environment-variables.html#编写一个大小写不敏感-search-函数的失败测试" class="sidebar-link">编写一个大小写不敏感 search 函数的失败测试</a></li><li class="sidebar-sub-header"><a href="/rust/ch12-05-working-with-environment-variables.html#实现-search-case-insensitive-函数" class="sidebar-link">实现 search_case_insensitive 函数</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="处理环境变量"><a href="#处理环境变量" class="header-anchor">#</a> 处理环境变量</h2> <blockquote><p><a href="https://github.com/rust-lang/book/blob/main/src/ch12-05-working-with-environment-variables.md" target="_blank" rel="noopener noreferrer">ch12-05-working-with-environment-variables.md<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <br>
commit f617d58c1a88dd2912739a041fd4725d127bf9fb</p></blockquote> <p>我们将增加一个额外的功能来改进 <code>minigrep</code>：用户可以通过设置环境变量来设置搜索是否是大小写敏感的 。当然，我们也可以将其设计为一个命令行参数并要求用户每次需要时都加上它，不过在这里我们将使用环境变量。这允许用户设置环境变量一次之后在整个终端会话中所有的搜索都将是大小写不敏感的。</p> <h3 id="编写一个大小写不敏感-search-函数的失败测试"><a href="#编写一个大小写不敏感-search-函数的失败测试" class="header-anchor">#</a> 编写一个大小写不敏感 <code>search</code> 函数的失败测试</h3> <p>我们希望增加一个新函数 <code>search_case_insensitive</code>，并将会在设置了环境变量时调用它。这里将继续遵循 TDD 过程，其第一步是再次编写一个失败测试。我们将为新的大小写不敏感搜索函数新增一个测试函数，并将老的测试函数从 <code>one_result</code> 改名为 <code>case_sensitive</code> 来更清楚的表明这两个测试的区别，如示例 12-20 所示：</p> <p><span class="filename">文件名: src/lib.rs</span></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">case_sensitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token string">&quot;duct&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token string">&quot;\
Rust:
safe, fast, productive.
Pick three.
Duct tape.&quot;</span><span class="token punctuation">;</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>
            <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">&quot;safe, fast, productive.&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> contents<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">case_insensitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token string">&quot;rUsT&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token string">&quot;\
Rust:
safe, fast, productive.
Pick three.
Trust me.&quot;</span><span class="token punctuation">;</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>
            <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">&quot;Rust:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Trust me.&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token function">search_case_insensitive</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> contents<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span class="caption">示例 12-20：为准备添加的大小写不敏感函数新增失败测试</span></p> <p>注意我们也改变了老测试中 <code>contents</code> 的值。还新增了一个含有文本 <code>&quot;Duct tape.&quot;</code> 的行，它有一个大写的 D，这在大小写敏感搜索时不应该匹配 &quot;duct&quot;。我们修改这个测试以确保不会意外破坏已经实现的大小写敏感搜索功能；这个测试现在应该能通过并在处理大小写不敏感搜索时应该能一直通过。</p> <p>大小写 <strong>不敏感</strong> 搜索的新测试使用 <code>&quot;rUsT&quot;</code> 作为其查询字符串。在我们将要增加的 <code>search_case_insensitive</code> 函数中，<code>&quot;rUsT&quot;</code> 查询应该包含带有一个大写 R 的 <code>&quot;Rust:&quot;</code> 还有 <code>&quot;Trust me.&quot;</code> 这两行，即便他们与查询的大小写都不同。这个测试现在不能编译，因为还没有定义 <code>search_case_insensitive</code> 函数。请随意增加一个总是返回空 vector 的骨架实现，正如示例 12-16 中 <code>search</code> 函数为了使测试通过编译并失败时所做的那样。</p> <h3 id="实现-search-case-insensitive-函数"><a href="#实现-search-case-insensitive-函数" class="header-anchor">#</a> 实现 <code>search_case_insensitive</code> 函数</h3> <p><code>search_case_insensitive</code> 函数，如示例 12-21 所示，将与 <code>search</code> 函数基本相同。唯一的区别是它会将 <code>query</code> 变量和每一 <code>line</code> 都变为小写，这样不管输入参数是大写还是小写，在检查该行是否包含查询字符串时都会是小写。</p> <p><span class="filename">文件名: src/lib.rs</span></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">search_case_insensitive</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> contents<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> results <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> line <span class="token keyword">in</span> contents<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> line<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    results
<span class="token punctuation">}</span>
</code></pre></div><p><span class="caption">示例 12-21：定义 <code>search_case_insensitive</code> 函数，它在比较查询和每一行之前将他们都转换为小写</span></p> <p>首先我们将 <code>query</code> 字符串转换为小写，并将其覆盖到同名的变量中。对查询字符串调用 <code>to_lowercase</code> 是必需的，这样不管用户的查询是 <code>&quot;rust&quot;</code>、<code>&quot;RUST&quot;</code>、<code>&quot;Rust&quot;</code> 或者 <code>&quot;rUsT&quot;</code>，我们都将其当作 <code>&quot;rust&quot;</code> 处理并对大小写不敏感。</p> <p>注意 <code>query</code> 现在是一个 <code>String</code> 而不是字符串 slice，因为调用 <code>to_lowercase</code> 是在创建新数据，而不是引用现有数据。如果查询字符串是 <code>&quot;rUsT&quot;</code>，这个字符串 slice 并不包含可供我们使用的小写的 <code>u</code> 或 <code>t</code>，所以必需分配一个包含 <code>&quot;rust&quot;</code> 的新 <code>String</code>。现在当我们将 <code>query</code> 作为一个参数传递给 <code>contains</code> 方法时，需要增加一个 &amp; 因为 <code>contains</code> 的签名被定义为获取一个字符串 slice。</p> <p>接下来在检查每个 <code>line</code> 是否包含 <code>search</code> 之前增加了一个 <code>to_lowercase</code> 调用将他们都变为小写。现在我们将 <code>line</code> 和 <code>query</code> 都转换成了小写，这样就可以不管查询的大小写进行匹配了。</p> <p>让我们看看这个实现能否通过测试：</p> <div class="language-text extra-class"><pre class="language-text"><code>running 2 tests
test tests::case_insensitive ... ok
test tests::case_sensitive ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div><p>好的！现在，让我们在 <code>run</code> 函数中实际调用新 <code>search_case_insensitive</code> 函数。首先，我们将在 <code>Config</code> 结构体中增加一个配置项来切换大小写敏感和大小写不敏感搜索。增加这些字段会导致编译错误，因为我们还没有在任何地方初始化这些字段：</p> <p><span class="filename">文件名: src/lib.rs</span></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Config</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> query<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> filename<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> case_sensitive<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里增加了 <code>case_sensitive</code> 字符来存放一个布尔值。接着我们需要 <code>run</code> 函数检查 <code>case_sensitive</code> 字段的值并使用它来决定是否调用 <code>search</code> 函数或 <code>search_case_insensitive</code> 函数，如示例 12-22 所示。注意这还不能编译：</p> <p><span class="filename">文件名: src/lib.rs</span></p> <div class="language-rust extra-class"><pre class="language-rust"><code># <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">;</span>
# <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
# <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
#
# <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">search</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> contents<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
#      <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
# <span class="token punctuation">}</span>
#
# <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">search_case_insensitive</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> contents<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
#      <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
# <span class="token punctuation">}</span>
#
# <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Config</span> <span class="token punctuation">{</span>
#     query<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
#     filename<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
#     case_sensitive<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
# <span class="token punctuation">}</span>
#
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> <span class="token class-name">Config</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">read_to_string</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token keyword">if</span> config<span class="token punctuation">.</span>case_sensitive <span class="token punctuation">{</span>
        <span class="token function">search</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">.</span>query<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">search_case_insensitive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">.</span>query<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> line <span class="token keyword">in</span> results <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span class="caption">示例 12-22：根据 <code>config.case_sensitive</code> 的值调用 <code>search</code> 或 <code>search_case_insensitive</code></span></p> <p>最后需要实际检查环境变量。处理环境变量的函数位于标准库的 <code>env</code> 模块中，所以我们需要在 <em>src/lib.rs</em> 的开头增加一个 <code>use std::env;</code> 行将这个模块引入作用域中。接着在 <code>Config::new</code> 中使用 <code>env</code> 模块的 <code>var</code> 方法来检查一个叫做 <code>CASE_INSENSITIVE</code> 的环境变量，如示例 12-23 所示：</p> <p><span class="filename">文件名: src/lib.rs</span></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>env<span class="token punctuation">;</span>
# <span class="token keyword">struct</span> <span class="token type-definition class-name">Config</span> <span class="token punctuation">{</span>
#     query<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
#     filename<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
#     case_sensitive<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
# <span class="token punctuation">}</span>

<span class="token comment">// --snip--</span>

<span class="token keyword">impl</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Config</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">&quot;not enough arguments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> query <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> filename <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> case_sensitive <span class="token operator">=</span> <span class="token namespace">env<span class="token punctuation">::</span></span><span class="token function">var</span><span class="token punctuation">(</span><span class="token string">&quot;CASE_INSENSITIVE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Config</span> <span class="token punctuation">{</span> query<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> case_sensitive <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span class="caption">示例 12-23：检查叫做 <code>CASE_INSENSITIVE</code> 的环境变量</span></p> <p>这里创建了一个新变量 <code>case_sensitive</code>。为了设置它的值，需要调用 <code>env::var</code> 函数并传递我们需要寻找的环境变量名称，<code>CASE_INSENSITIVE</code>。<code>env::var</code> 返回一个 <code>Result</code>，它在环境变量被设置时返回包含其值的 <code>Ok</code> 成员，并在环境变量未被设置时返回 <code>Err</code> 成员。</p> <p>我们使用 <code>Result</code> 的 <code>is_err</code> 方法来检查其是否是一个 error（也就是环境变量未被设置的情况），这也就意味着我们 <strong>需要</strong> 进行一个大小写敏感搜索。如果<code>CASE_INSENSITIVE</code> 环境变量被设置为任何值，<code>is_err</code> 会返回 false 并将进行大小写不敏感搜索。我们并不关心环境变量所设置的 <strong>值</strong>，只关心它是否被设置了，所以检查 <code>is_err</code> 而不是 <code>unwrap</code>、<code>expect</code> 或任何我们已经见过的 <code>Result</code> 的方法。</p> <p>我们将变量 <code>case_sensitive</code> 的值传递给 <code>Config</code> 实例，这样 <code>run</code> 函数可以读取其值并决定是否调用 <code>search</code> 或者示例 12-22 中实现的 <code>search_case_insensitive</code>。</p> <p>让我们试一试吧！首先不设置环境变量并使用查询 <code>to</code> 运行程序，这应该会匹配任何全小写的单词 “to” 的行：</p> <div class="language-text extra-class"><pre class="language-text"><code>$ cargo run to poem.txt
   Compiling minigrep v0.1.0 (file:///projects/minigrep)
    Finished dev [unoptimized + debuginfo] target(s) in 0.0 secs
     Running `target/debug/minigrep to poem.txt`
Are you nobody, too?
How dreary to be somebody!
</code></pre></div><p>看起来程序仍然能够工作！现在将 <code>CASE_INSENSITIVE</code> 设置为 <code>1</code> 并仍使用相同的查询 <code>to</code>。</p> <p>如果你使用 PowerShell，则需要用两个命令来设置环境变量并运行程序：</p> <div class="language-text extra-class"><pre class="language-text"><code>$ $env:CASE_INSENSITIVE=1
$ cargo run to poem.txt
</code></pre></div><p>这回应该得到包含可能有大写字母的 “to” 的行：</p> <div class="language-text extra-class"><pre class="language-text"><code>$ CASE_INSENSITIVE=1 cargo run to poem.txt
    Finished dev [unoptimized + debuginfo] target(s) in 0.0 secs
     Running `target/debug/minigrep to poem.txt`
Are you nobody, too?
How dreary to be somebody!
To tell your name the livelong day
To an admiring bog!
</code></pre></div><p>好极了，我们也得到了包含 “To” 的行！现在 <code>minigrep</code> 程序可以通过环境变量控制进行大小写不敏感搜索了。现在你知道了如何管理由命令行参数或环境变量设置的选项了！</p> <p>一些程序允许对相同配置同时使用参数 <strong>和</strong> 环境变量。在这种情况下，程序来决定参数和环境变量的优先级。作为一个留给你的测试，尝试通过一个命令行参数或一个环境变量来控制大小写不敏感搜索。并在运行程序时遇到矛盾值时决定命令行参数和环境变量的优先级。</p> <p><code>std::env</code> 模块还包含了更多处理环境变量的实用功能；请查看官方文档来了解其可用的功能。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/rust/assets/js/app.4b754adf.js" defer></script><script src="/rust/assets/js/2.75a4d7fc.js" defer></script><script src="/rust/assets/js/69.6ff560c5.js" defer></script>
  </body>
</html>
